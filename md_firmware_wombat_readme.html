<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wombat Environmental Node: Wombat Firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Wombat Environmental Node<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">An environmental node for SDI-12 and digital sensors.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_firmware_wombat_readme.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Wombat Firmware </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md21"></a>
Overview</h1>
<p >The Wombat is a simple data logger whose basic runtime sequence is:</p>
<ol type="1">
<li>Connect to the internet and use NTP to set the time.</li>
<li>Read the solar and battery bus voltages.</li>
<li>Read all attached SDI-12 sensors with addresses in the range of 0 - 9.</li>
<li>Read and reset the pulse count from the <code>Digital</code> input.</li>
<li>Create a JSON message with these values, plus miscellaneous node information such as the SIM card CCID, basic mobile signal strength, serial number, firmware version etc.</li>
<li>Append the message to the <code>data.json</code> file on the SD card if the card is present.</li>
<li>Write the message to a file on the ESP-32 SPIFFS filesystem.</li>
<li>If this is an uplink cycle, send all messages found on the SPIFFS filesystem to an MQTT broker.</li>
<li>If a configuration script was received from the MQTT broker, run it.</li>
<li>Enter deep sleep until the next measurement cycle.</li>
</ol>
<p >The firmware is written using the <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/getting_started.html">ESP-32 Arduino platform</a> because Arduino libraries are used. <a href="https://platformio.org/">PlatformIO</a> is used for building.</p>
<p >The Wombat currently has a 1024 byte limit on the length of the telemetry message. This is sufficient for current deployments.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Command Line Interface</h1>
<p >Wombats are configured using a command line interface (<a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a>). This is available via a UART or by publishing a script to an MQTT topic.</p>
<p >After the output from most commands, the Wombat will print <code>OK</code> on success or <code>ERROR: [optional message]</code> if a command fails. The OK/ERROR string is printed on a new line delimited by CRLF, for example: <code>\r\nOK\r\n</code>.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Access the CLI via the USB-C port</h1>
<p >To use the command line via the UART header or USB-C port on the Wombat, short the <code>External Button</code> header while rebooting.</p>
<p >The USB-C port does not have both sets of data pins connected, so try the USB-C cable in both orientations.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Access the CLI via the UART header</h1>
<p >The UART header (located just under the ESP32 module) can be used to print console messages from the Wombat. Log messages are transmitted via the TX.</p>
<p >To enable the RX pin so commands can be entered, break the solder jumper <code>JP1</code> on the back of the PCB.</p>
<blockquote class="doxtable">
<p >&zwj;WARNING: While this jumper is broken the USB-C port will not accept commands, but it will still emit log messages. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md25"></a>
Send CLI commands via MQTT</h1>
<p >A Wombat checks for a configuration scrip every time it connects to the MQTT server, using its serial number as the in the topic name. For example, if the boot messages show:</p>
<div class="fragment"><div class="line">[    39][I][main.cpp:135] timeout_task(): [wombat] Starting</div>
<div class="line">[  1307][I][DeviceConfig.cpp:66] reset(): [config] Resetting values to defaults</div>
<div class="line">[  1308][I][DeviceConfig.cpp:72] reset(): [config] Node Id: B8D61A017074</div>
<div class="line">[  1310][I][main.cpp:194] setup(): [wombat] Wake up time: 1970-01-01T00:00:18Z</div>
</div><!-- fragment --><p >then the <code>Node Id</code> is <code>B8D61A017074</code> and the topic the Wombat will read commands from is <code>wombat/B8D61A017074</code>.</p>
<p >If a configuration script is found, the Wombat downloads it and publishes an empty message to the topic to clear the script.</p>
<p >Configuration scripts must the published as a retained message, meaning the message will persist in the topic until a new retained message is written to the topic. To clear the configuration script from the topic, an empty message is published by the Wombat after receiving the configuration script.</p>
<blockquote class="doxtable">
<p >&zwj;Some commands should not be used in configuration scripts. These commands are marked with <code>[<a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a> only]</code> in the command reference below. </p>
</blockquote>
<p>Below is an excerpt of the logging messages showing the downloading and clearing of a configuration script from the MQTT server.</p>
<div class="fragment"><div class="line">AT+UMQTTC=1</div>
<div class="line"> </div>
<div class="line">OK</div>
<div class="line">[1884670][I][mqtt_stack.cpp:20] mqttCmdCallback(): [mqtt_stack] cmd: 1, result: 1</div>
<div class="line">[1884697][I][Utils.h:73] hasURC(): [CommandURCVector] valid = 1, command = 1, result = 1, err1 = 0, err2 = 0</div>
<div class="line">[1884715][I][Utils.h:101] waitForURC(): [CommandURCVector] command = 1, result = 1, found_urc = 1, retries = 59</div>
<div class="line">[1884751][I][mqtt_stack.cpp:86] mqtt_login(): [mqtt_stack] Connected to MQTT</div>
<div class="line">AT+UMQTTC=4,1,&quot;wombat/B8D61A017074&quot;</div>
<div class="line"> </div>
<div class="line">OK</div>
<div class="line">[1884759][I][mqtt_stack.cpp:105] mqtt_login(): [mqtt_stack] Checking for a config script, waiting for subscribe URC</div>
<div class="line">[1885466][I][mqtt_stack.cpp:20] mqttCmdCallback(): [mqtt_stack] cmd: 4, result: 1</div>
<div class="line">[1885485][I][mqtt_stack.cpp:20] mqttCmdCallback(): [mqtt_stack] cmd: 6, result: 1</div>
<div class="line">[1885503][I][Utils.h:73] hasURC(): [CommandURCVector] valid = 1, command = 4, result = 1, err1 = 0, err2 = 0</div>
<div class="line">[1885521][I][Utils.h:101] waitForURC(): [CommandURCVector] command = 4, result = 1, found_urc = 1, retries = 23</div>
<div class="line">[1885539][I][mqtt_stack.cpp:109] mqtt_login(): [mqtt_stack] out of sub urc loop, checking values: result = 1</div>
<div class="line">[1885561][I][Utils.h:73] hasURC(): [CommandURCVector] valid = 1, command = 6, result = 1, err1 = 0, err2 = 0</div>
<div class="line">[1885580][I][Utils.h:101] waitForURC(): [CommandURCVector] command = 6, result = 1, found_urc = 1, retries = 20</div>
<div class="line">[1885598][I][mqtt_stack.cpp:118] mqtt_login(): [mqtt_stack] out of read urc loop, result = 1</div>
<div class="line">[1885616][I][mqtt_stack.cpp:122] mqtt_login(): [mqtt_stack] Config download waiting.</div>
<div class="line">AT+UMQTTC=6,1</div>
<div class="line"> </div>
<div class="line">+UMQTTC: 6,1,59,19,&quot;wombat/B8D61A017074&quot;,40,&quot;ftp login</div>
<div class="line">ftp upload log.txt</div>
<div class="line">ftp logout</div>
<div class="line">&quot;</div>
<div class="line"> </div>
<div class="line">OK</div>
<div class="line">AT+UMQTTC=2,0,1,0,&quot;wombat/B8D61A017074&quot;,&quot;&quot;</div>
<div class="line">15:23:26.063 &gt;</div>
<div class="line">OK</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md26"></a>
Example scripts</h2>
<p >A script to upload the data and log files, and then clear the log file:</p>
<div class="fragment"><div class="line">ftp login</div>
<div class="line">ftp upload data.json</div>
<div class="line">ftp upload log.txt</div>
<div class="line">ftp logout</div>
<div class="line">sd rm log.txt</div>
</div><!-- fragment --><p >A script unconditionally update the firmware and reboot to quickly get a message with the new firmware version identifier:</p>
<div class="fragment"><div class="line">config ota 1</div>
<div class="line">config reboot</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md27"></a>
Command Reference</h1>
<h2><a class="anchor" id="autotoc_md28"></a>
config</h2>
<h3><a class="anchor" id="autotoc_md29"></a>
config list</h3>
<p >The <code>config list</code> command lists various configuration settings as a set of configuration commands that can be pasted into another Wombats <a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a> to copy the configuration.</p>
<div class="fragment"><div class="line">$ config list</div>
<div class="line">interval measure 900</div>
<div class="line">interval uplink 900</div>
<div class="line">interval clockmult 1.0</div>
<div class="line">mqtt host mqtt_server.example.com</div>
<div class="line">mqtt port 1883</div>
<div class="line">mqtt user mqtt_username</div>
<div class="line">mqtt password mqtt_password_in_cleartext</div>
<div class="line">mqtt topic wombat</div>
<div class="line">ftp host ftp_server.example.com</div>
<div class="line">ftp user ftp</div>
<div class="line">ftp password ftp_password_in_cleartext</div>
<div class="line"> </div>
<div class="line">OK</div>
<div class="line">$</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md30"></a>
config save</h3>
<p >Saves the configuration to non-volatile storage.</p>
<h3><a class="anchor" id="autotoc_md31"></a>
config load</h3>
<p >Loads the Wombat configuration from non-volatile storage. The configuration must have been saved previously.</p>
<h3><a class="anchor" id="autotoc_md32"></a>
config dto &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Disables the 60-minute timeout that will reboot the Wombat if it is still running. This timeout is enabled by default.</p>
<h3><a class="anchor" id="autotoc_md33"></a>
config eto &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Enables the 60-minute timeout that will reboot the Wombat if it is still running. This timeout is enabled by default.</p>
<h3><a class="anchor" id="autotoc_md34"></a>
config ota</h3>
<p >Triggers an over-the-air update. By default, this command checks the version on FTP the server and only downloads it if it is newer than what is running on the Wombat. This can be over-ridden by supplying an argument of '1'.</p>
<p >Example: <code>config ota 1</code> force an update of the firmware.</p>
<h3><a class="anchor" id="autotoc_md35"></a>
config sdi12defn</h3>
<p >Downloads the <a href="data/sdi12defn.json">sdi12defn.json</a> file from the FTP server. No version checking is done, the file is always downloaded and replaces what is currently on the Wombat.</p>
<blockquote class="doxtable">
<p >&zwj;See SDI-12 Sensor Definitions </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md36"></a>
config reboot</h3>
<p >Performs a clean shutdown and reboots the Wombat.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
interval</h2>
<h3><a class="anchor" id="autotoc_md38"></a>
interval list</h3>
<p >Lists the interval settings as a set of configuration commands that can be pasted into another Wombats <a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a> to copy the configuration.</p>
<div class="fragment"><div class="line">interval measure 900</div>
<div class="line">interval uplink 900</div>
<div class="line">interval clockmult 1.0</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md39"></a>
interval measure</h3>
<p >Sets the interval, in seconds, that the Wombat will wake up and record data from the sensors.</p>
<p >Example: <code>interval measure 900</code> takes measurements every 15 minutes.</p>
<h3><a class="anchor" id="autotoc_md40"></a>
interval uplink</h3>
<p >Sets the interval, in seconds, that the Wombat will upload data to the MQTT broker. This must be a multiple of the measurement interval.</p>
<p >Example: <code>interval uplink 3600</code> uploads data every hour.</p>
<h3><a class="anchor" id="autotoc_md41"></a>
interval clockmult</h3>
<p >Sets the coefficient used to adjust the sleep time if clock drift is a problem. The time to sleep is calculated in milliseconds, converted to micro-seconds, and this coefficient is applied to the microsecond value.</p>
<p >Example: <code>interval clockmult 1.006</code></p>
<h2><a class="anchor" id="autotoc_md42"></a>
power</h2>
<h3><a class="anchor" id="autotoc_md43"></a>
power show</h3>
<p >Prints the solar and battery voltages.</p>
<h2><a class="anchor" id="autotoc_md44"></a>
sd - work with the SD card</h2>
<h3><a class="anchor" id="autotoc_md45"></a>
sd rm</h3>
<p >Deletes a file from the SD card. All files are in the root directory and need no prefix on the name. Only two files exist on the SD card, <code>data.json</code> and <code>log.txt</code>. No quotes are required around the filename. Only a single filename may be supplied.</p>
<p >Example: <code>sd rm log.txt</code> will delete the log file.</p>
<h3><a class="anchor" id="autotoc_md46"></a>
sd data &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Prints the <code>data.json</code> file to the console. The contents are surrounded by <code>[</code> and <code>]</code> to make it a JSON array.</p>
<h3><a class="anchor" id="autotoc_md47"></a>
sd log &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Prints the <code>log.txt</code> file to the console.</p>
<h2><a class="anchor" id="autotoc_md48"></a>
sdi12 - work with SDI-12 sensors</h2>
<h3><a class="anchor" id="autotoc_md49"></a>
sdi12 scan</h3>
<p >Scans the SDI-12 bus, prints the sensors found and populates the SDI-12 sensor data structure.</p>
<h3><a class="anchor" id="autotoc_md50"></a>
sdi12 m &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Performs a measurement on an SDI-12 sensor with the supplied address. If the type of the sensor is in the <code>sdi12defns.json</code> file then the commands and field mask in that file are used, otherwise a measure command is used and all values are printed.</p>
<p >Example: <code>sdi12 m 1</code> reads SDI-12 sensor with address 1 and prints the values.</p>
<h3><a class="anchor" id="autotoc_md51"></a>
sdi12 &gt;&gt;</h3>
<p >Sends a command to the SDI-12 bus and prints the response. The whole argument to this command is sent as the SDI-12 command.</p>
<p >Example: <code>sdi12 &gt;&gt; 0A8!</code> changes the address of sensor 0 to 8.</p>
<h3><a class="anchor" id="autotoc_md52"></a>
sdi12 pt &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Enters SDI-12 passthrough mode. In this mode all characters typed are sent directly to the SDI-12 bus and all characters received from the bus are printed to the console.</p>
<p >Exit passthrough mode with ctrl-D.</p>
<h2><a class="anchor" id="autotoc_md53"></a>
c1 - work with the Cat-M1 modem</h2>
<h3><a class="anchor" id="autotoc_md54"></a>
c1 pwr &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Switches power to the modem on or off. The modem is switched off by default and must be powered before it can be used. When testing the Wombat from the command line and wanting to use the modem, issue <code>c1 pwr 1</code> to supply power to the modem. <code>c1 pwr 0</code> will remove power from the modem, and will issue a power off AT command if a previous <code>c1 cti</code> command was successful.</p>
<p >Example: <code>c1 pwr 1</code> switches on the modem power bus.</p>
<h3><a class="anchor" id="autotoc_md55"></a>
c1 cti &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Attempts to connect the Wombat to the internet. Will also get the time via NTP. This command will enable power to the modem the first time it is run.</p>
<h3><a class="anchor" id="autotoc_md56"></a>
c1 ls</h3>
<p >Lists files on the modem filesystem.</p>
<h3><a class="anchor" id="autotoc_md57"></a>
c1 rm</h3>
<p >Deletes a file from the modem filesystem. No quotes are required around the filename. Only a single filename may be supplied.</p>
<p >Example: <code>c1 rm wombat.sha1</code> removes the <code>wombat.sha1</code> file from the modem filesystem.</p>
<h3><a class="anchor" id="autotoc_md58"></a>
c1 factory &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Attempts to reset the modem to factory defaults using the <code>AT+UFACTORY=2,2</code> command.</p>
<h3><a class="anchor" id="autotoc_md59"></a>
c1 ntp</h3>
<p >Issues an NTP request to set the RTC of the Wombat.</p>
<h3><a class="anchor" id="autotoc_md60"></a>
c1 ok</h3>
<p >Issues an <code>ATI</code> command and prints the response as a basic modem UART test.</p>
<h3><a class="anchor" id="autotoc_md61"></a>
c1 pt &lt;tt&gt;[CLI only]&lt;/tt&gt;</h3>
<p >Enters passthrough mode on the modem UART. In this mode all characters typed are sent directly to the modem and all characters received from the modem are printed to the console.</p>
<p >Exit passthrough mode with ctrl-D.</p>
<h2><a class="anchor" id="autotoc_md62"></a>
mqtt</h2>
<h3><a class="anchor" id="autotoc_md63"></a>
mqtt list</h3>
<p >Lists the MQTT settings as a set of configuration commands that can be pasted into another Wombats <a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a> to copy the configuration.</p>
<h3><a class="anchor" id="autotoc_md64"></a>
mqtt host</h3>
<p >Sets the MQTT hostname. A hostname or IPv4 address can be used.</p>
<p >Example: <code>mqtt hostname mqtt.example.com</code></p>
<h3><a class="anchor" id="autotoc_md65"></a>
mqtt port</h3>
<p >Sets the MQTT port number. Must be an integer.</p>
<p >Example: <code>mqtt port 1883</code></p>
<h3><a class="anchor" id="autotoc_md66"></a>
mqtt user</h3>
<p >Sets the MQTT username.</p>
<p >Example: <code>mqtt user example_user</code></p>
<h3><a class="anchor" id="autotoc_md67"></a>
mqtt password</h3>
<p >Sets the MQTT password.</p>
<p >Example: <code>mqtt password an_example_password</code></p>
<h3><a class="anchor" id="autotoc_md68"></a>
mqtt topic</h3>
<p >Sets the name of the topic that test messages sent via <code>mqtt publish</code> are published to. Note this setting has no impact on messages sent from the usual running of the Wombat.</p>
<p >Example: <code>mqtt topic test_topic</code></p>
<h3><a class="anchor" id="autotoc_md69"></a>
mqtt login</h3>
<p >Attempt to log in to a MQTT server using the current configuration settings.</p>
<h3><a class="anchor" id="autotoc_md70"></a>
mqtt logout</h3>
<p >Log out of the MQTT server.</p>
<h3><a class="anchor" id="autotoc_md71"></a>
mqtt publish</h3>
<p >Publish a test message to the MQTT server. The message content is 'ABCDEF' and is published to the topic set with <code>mqtt topic</code>.</p>
<h2><a class="anchor" id="autotoc_md72"></a>
ftp</h2>
<h3><a class="anchor" id="autotoc_md73"></a>
ftp list</h3>
<p >Lists the FTP settings as a set of configuration commands that can be pasted into another Wombats <a class="el" href="class_c_l_i.html" title="FreeRTOS command line interface.">CLI</a> to copy the configuration.</p>
<h3><a class="anchor" id="autotoc_md74"></a>
ftp host</h3>
<p >Sets the FTP hostname. A hostname or IPv4 address can be used.</p>
<p >Example: <code>ftp hostname ftp.example.com</code></p>
<h3><a class="anchor" id="autotoc_md75"></a>
ftp user</h3>
<p >Sets the FTP username.</p>
<p >Example: <code>ftp user example_user</code></p>
<h3><a class="anchor" id="autotoc_md76"></a>
ftp password</h3>
<p >Sets the FTP password.</p>
<p >Example: <code>ftp password an_example_password</code></p>
<h3><a class="anchor" id="autotoc_md77"></a>
ftp login</h3>
<p >Attempt to log in to a FTP server using the current configuration settings.</p>
<h3><a class="anchor" id="autotoc_md78"></a>
ftp logout</h3>
<p >Log out of the FTP server.</p>
<h3><a class="anchor" id="autotoc_md79"></a>
ftp get</h3>
<p >Get a file from the FTP server. The file must be in the root directory of the FTP server.</p>
<p >No quotes are necessary around the filename, and only a single filename is accepted. No whitespace is allowed in the filename.</p>
<p >The file is written to the modem filesystem.</p>
<p >Example: <code>ftp get wombat.sha1</code></p>
<h3><a class="anchor" id="autotoc_md80"></a>
ftp upload</h3>
<p >Uploads a file from the SD card to the FTP server. The file is written to a directory named <code>uploads/node_SERIALNO</code> where SERIALNO is the Wombat serial number.</p>
<p >No quotes are necessary around the filename, and only a single filename is accepted. No whitespace is allowed in the filename.</p>
<p >Example: <code>ftp upload log.txt</code></p>
<h1><a class="anchor" id="autotoc_md81"></a>
SDI-12 sensors</h1>
<h2><a class="anchor" id="autotoc_md82"></a>
The SDI-12 Bus</h2>
<p >Up to 10 SDI-12 sensors may be connected to the Wombat using addresses 0 - 9.</p>
<p >When the Wombat boots it scans the SDI-12 bus for sensors on these addresses and builds a list of the sensors found. Every sensor on the list is read during the measurement cycle.</p>
<p >SDI-12 Sensors are connected to the <code>OUTPUT</code> header and may be powered via the <code>3V3</code> line or the <code>12 V</code> line. The <code>3V3</code> is powered as long as the batteries are connected via the <code>Power Button</code> header, including when the Wombat is asleep. All SDI-12 sensor data wires must be connected to the <code>SDI-12</code> line.</p>
<p >The always-on <code>3V3</code> line is useful for sensors such as automatic weather stations which must be always on for recording rain and wind events.</p>
<p >The <code>12 V</code> line is only powered while the Wombat is awake.</p>
<h2><a class="anchor" id="autotoc_md83"></a>
SDI-12 Sensor Definitions</h2>
<p >If a file named <a href="data/sdi12defn.json"><code>sdi12defns.json</code></a> exists on the ESP-32 SPIFFS filesystem, it will be used to determine which commands to use when reading data from SDI-12 sensors, what labels to give the values, and to filter unwanted values.</p>
<p >The general layout of the file is:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;vendor&quot;: {</div>
<div class="line">    &quot;model&quot;: {</div>
<div class="line">      &quot;read_cmds&quot;: [ cmd1, ... ],</div>
<div class="line">      &quot;value_mask&quot;: &quot;10110&quot;,</div>
<div class="line">      &quot;labels&quot;: [ &quot;Field_1&quot;, ... ],</div>
<div class="line">      &quot;ignore_sr&quot;: true</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p> where:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">vendor   </td><td class="markdownTableBodyNone">The vendor identifier returned by the sensor in the response to an identify command.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">model   </td><td class="markdownTableBodyNone">The sensor model identifier returned by the sensor in the response to an identify command.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">read_cmds   </td><td class="markdownTableBodyNone">A list of commands to send to read values. The command must start with <code>a</code>, a placeholder for the sensor address, and end with <code>!</code>. For example: <code>"aC!"</code> or <code>"aC2!"</code>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">value_mask   </td><td class="markdownTableBodyNone">Optional - a string of <code>0</code> and <code>1</code> which can be used to mask out unwanted values. Use <code>0</code> to drop a value. For example: <code>"110"</code> drops the 3rd value read from the sensor.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">labels   </td><td class="markdownTableBodyNone">A list of names to give the values in the telemetry message. The names are prefixed with the sensor address, so a name of <code>"Temperature"</code> will appear in the message as <code>"1_Temperature"</code> if it is read from sensor address 1.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ignore_sr   </td><td class="markdownTableBodyNone">Optional - a boolean that can be used to tell the Wombat to always wait for the full length of time the sensor claimed a measurement will take. The Wombat will read and ignore the service request from the sensor.   </td></tr>
</table>
<blockquote class="doxtable">
<p >&zwj;If a sensor definition cannot be found for a sensor, the Wombat issues a basic measure command <code>aM!</code>, and labels the values <code>"a_Vn"</code> where <code>a</code> is the sensor address and <code>n</code> is the number of the value, from 0 to <em>n-1</em> where <em>n</em> is the number of values read back from the sensor. For example, a temperature and humidity sensor at address 5 would have values labelled <code>5_V0</code> and <code>5_V1</code>. </p>
</blockquote>
<p>A new version of the <code>sdi12defns.json</code> file can be downloaded from the root directory of the FTP server using the <code>config sdi12dfns</code> command.</p>
<h1><a class="anchor" id="autotoc_md84"></a>
Firmware Updates</h1>
<p >The firmware can be updated over-the-air via the <code>config ota</code> command.</p>
<p >A binary image named <code>wombat.bin</code> and an information file named <code>wombat.sha1</code> must must be present in the root directory of the FTP server.</p>
<p >The information file contains a single line of text with the following fields:</p>
<div class="fragment"><div class="line">version length firmware-image-sha1-sig git-commit-id</div>
</div><!-- fragment --><p >for example:</p>
<div class="fragment"><div class="line">1.0.7 546064 4efb177a5d132ed22e9f045f03e61b9a1d85cacd 7b5b8c08f67312f4c587a83316fbbdc911a5df6d</div>
</div><!-- fragment --><p >This file is generated by the <a href="split_firmware.sh">split_firmware.sh</a> script, which is run by <a href="scp_firmware.sh">scp_firmware.sh</a>.</p>
<h2><a class="anchor" id="autotoc_md85"></a>
Uploading Firmware to the FTP Server</h2>
<p >The <a href="scp_firmware.sh">scp_firmware.sh</a> script is used to generate the information file and upload both it and the firmware image to an FTP server. Note the script uses SSH to copy the files, not FTP.</p>
<p >Two environment variables are used by the script:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Environment variable   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SSH_HOST   </td><td class="markdownTableBodyNone">This variable is expected to contain an SSH host identifier from the ~/.ssh/config file. It may work to set it to something like <code>-i ~/.ssh/my_key user@host</code> but this has not been tested.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">DEST_DIR   </td><td class="markdownTableBodyNone">The directory on the host to copy the files to. This must equate to the FTP server root directory, for example <code>/srv/ftp</code>.   </td></tr>
</table>
<blockquote class="doxtable">
<p >&zwj;The script must be run from the <code>src/firmware/wombat</code> directory. </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md86"></a>
Requesting a Firmware Update</h2>
<p >Issuing a <code>config ota</code> command will cause the Wombat to log in to the FTP server, download the <code>wombat.sha1</code> file and use this to check if the software on the server is newer than what is running on the Wombat. If so, the Wombat downloads and installs the new firmware image and switches over on the next boot.</p>
<p >To force a firmware update issue the <code>config ota 1</code> command. This is useful during development when the version number of the firmware is not changing, or perhaps to downgrade the firmware. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
